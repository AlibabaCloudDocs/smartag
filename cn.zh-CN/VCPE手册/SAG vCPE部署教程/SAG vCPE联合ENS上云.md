# SAG vCPE联合ENS上云

本文为您介绍如何通过智能接入网关（SAG）vCPE和边缘节点服务（ENS）将您的网络接入阿里云。

在您开始操作前，请确保您已经满足以下条件：

-   您已经开通ENS。具体操作，请参见[开通服务]()。
-   您已经创建了专有网络（VPC）。具体操作，请参见[使用专有网络](/cn.zh-CN/专有网络和交换机/使用专有网络.md)。

SAG vCPE是智能接入网关的软件镜像版，突破了物理的限制，可以支持任意形态的网络加密接入阿里云。您可以将SAG vCPE镜像部署在云服务器中，也可以将其部署在阿里云ENS实例中。部署后，SAG vCPE作为一个虚拟CPE设备帮您提供服务，不受硬件设备物理限制和地域约束，可以更灵活地帮您将网络接入阿里云。

本文以下图场景为例，为您介绍SAG vCPE如何联合ENS将您的网络接入阿里云。某上海企业已经在阿里云上海地域部署了VPC，该企业计划在华东区域的ENS上部署业务系统，并希望通过SAG vCPE实现ENS业务系统和云上资源互通。本场景中计划创建两个ENS实例，其中一个ENS实例用于部署业务系统，另一个ENS实例用于部署SAG vCPE。两个ENS实例部署在相同的节点中，实例之间私网互通。部署完成后，业务系统可通过SAG vCPE与云上资源互通。

![ENS上云-new](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7713129951/p139298.png)

## 部署流程

![部署流程](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7713129951/p139346.png)

## 步骤一：购买SAG vCPE设备

您需要在智能接入网关管理控制台，购买SAG vCPE设备和带宽，购买后系统会为您创建一个SAG vCPE实例，以便您管理SAG vCPE设备并对其进行网络配置。

1.  登录[智能接入网关管理控制台](https://smartag.console.aliyun.com)。

2.  在智能接入网关页面，单击**购买智能接入网关**。

3.  在智能接入网关页面，选择**购买智能接入网关** \> **创建智能接入网关（VCPE）**

4.  根据以下信息配置SAG vCPE购买信息，然后单击**立即购买**。

    -   **区域**：选择SAG vCPE使用的区域。本示例选择**中国内地**。
    -   **实例名称**：输入SAG vCPE的实例名称。

        实例名称为非必填参数，长度为2~128个字符，以大小写字母或中文开头，可包含数字，半角句号（.），下划线（\_）或短划线（-）。

    -   **实例类型**：选择SAG vCPE的实例类型。默认为**SAG-vCPE**。
    -   **版本**：选择SAG vCPE的版本。默认为**基础版**。
    -   **使用方式**：选择SAG vCPE的使用方式。默认为**双机**。

        购买两台SAG vCPE，共享上云接入带宽，主设备故障时可切换到备用设备。本示例中只使用主设备。

    -   **带宽峰值**：网络通信的带宽峰值。
    -   **购买数量**：选择您需要购买的SAG vCPE的数量。本示例输入**1**。
    -   **购买时长**：选择购买时长。

        您可以选中下方的**到期自动续费**进行自动续费。

5.  在确认订单页面，确认订单信息并选中**我已阅读并同意《智能接入网关vCPE软件版服务协议》**，单击**去支付**。

6.  返回智能接入网关管理控制台，在顶部菜单栏，选择刚刚创建实例的区域。

7.  在**智能接入网关**页面，单击刚刚创建的实例ID链接。

8.  在智能接入网关详情页面，单击**设备管理**，查看并记录当前SAG vCPE主设备的序列号和密钥。

    ![查看SN和密钥](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1086359951/p137880.png)


## 步骤二：部署ENS

ENS基于运营商边缘节点和网络构建，一站式提供靠近终端用户的、全域覆盖的、弹性分布式算力资源，通过终端数据就近计算和处理，优化响应时延、中心负荷和整体成本，帮助您将业务下沉至运营商侧边缘，有效降低计算时延和成本。更多信息，请参见[什么是边缘节点服务ENS]()。

1.  ENS私网网段预部署。

    ENS私网网段预部署由阿里云边缘计算团队帮您操作，需要您[提交工单](https://workorder.console.aliyun.com/console.htm#/ticket/add?productCode=ens&commonQuestionId=3529&isSmart=true&iatraceid=1596766108913-29cb6a9ef077eac66c88e6&channel=selfservice)申请。

    在部署ENS前，您可以将ENS实例所需的私网网段（请根据全网规划IP地址，避免IP地址冲突）发给阿里云边缘计算团队，边缘计算团队会从网络大段中分一个小段出来给每个节点使用，保证每个节点的私网IP地址不重复。

    本示例预部署的IP地址网段为10.0.0.0/8，划分给业务系统和SAG vCPE的私网IP地址段为10.0.2.0/24。

2.  创建SAG vCPE镜像。

    SAG vCPE镜像可以被承载在ENS实例上，您创建ENS时，需要将实例的镜像部署为SAG vCPE类型。

    SAG vCPE镜像由阿里云网络团队帮您制作，您需要[提交工单](https://workorder.console.aliyun.com/console.htm?spm=a2c8b.12571063.0.0.6c3a1f74GNUcri#/ticket/add?productCode=smartag&commonQuestionId=3317&isSmart=true)并提供您的阿里云账户UID。

    制作成功后，您可以在ENS控制台查看SAG vCPE镜像。

    1.  登录[ENS控制台](https://ens.console.aliyun.com/#/overview)。

    2.  在左侧导航栏，单击**镜像**。

    3.  在**自定义镜像**页面，查看已创建的SAG vCPE镜像。

        ![查看镜像](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7713129951/p139109.png)

3.  创建边缘服务，用于承载SAG vCPE镜像。

    1.  登录[ENS控制台](https://ens.console.aliyun.com/#/overview)。

    2.  在**边缘服务**页面，单击**创建边缘服务**。

    3.  配置基础配置。

        -   **服务名称**：您可以填写不超过30个字符的自定义名称。
        -   **镜像**：ENS支持自定义镜像和公共镜像。本示例选择**自定义镜像**，选择已经成功导入的SAG vCPE镜像。
        -   **规格**：请选择SAG vCPE镜像要安装的实例规格。本示例选择**2C4G**。

            SAG vCPE镜像在2C4G实例规格下，加密私网带宽可达300 Mbps以上（1024字节）。SAG vCPE镜像也支持1C2G的实例规格，在此规格下系统性能会降低30%以上，您可根据业务需要进行选择。

            **说明：** C指vCPU，G指内存。例如：计算型1C2G指vCPU1核，内存2 GB。

        -   **存储**：您可以自由搭配系统盘和数据盘大小。

            系统盘大小要求是10的倍数，并且最大为100 GB。您可以[提交工单](https://workorder-intl.console.aliyun.com/#/ticket/createIndex)或加入钉钉群（21740823）进行申请。

        -   **带宽**：公网带宽计费方式默认月第四峰值，您可以设置单实例公网限速。

            算力计费周期与带宽一致，边缘服务创建成功即开始计费。

        -   **登录密码**：8~30个字符，必须包含大写字母、小写字母、数字和特殊字符至少3种。
    4.  单击**下一步：边缘算例分布**，开始配置边缘算力分布。

        -   **网络层级**：默认选择大区级。

            **说明：** 系统在所选网络层级内智能选点、下发算力，如有指定位置需求，您可以[提交工单](https://workorder-intl.console.aliyun.com/#/ticket/createIndex)或加入钉钉群（21740823）进行申请。

        -   **节点调度策略**：分散度可选择城市分散或城市集中。本示例选择**城市分散**和**优先高价**。

            **说明：** 当所选区域需要多台实例时，城市分散策略表示实例尽量调度到不同城市，城市集中策略表示实例尽量调度到同一城市。

        -   **区域**：您可以自定义添加或删除东北、华东、华北、华中、华南、西南、西北的电信、联通、移动运营商实例。本示例添加**华东**大区，1个**移动实例**。
    5.  单击**下一步：服务配置确认**。

    6.  确认配置后，选中**同意《边缘节点服务ENS服务条款》**。

    7.  单击**确定创建**完成创建。

4.  请根据上述步骤，再次创建ENS，用于部署业务系统。

    在您创建ENS时，请注意以下事项：

    -   请根据您的业务需要选择镜像，无需再选择SAG vCPE镜像。
    -   关于**区域**部分，请选择和SAG vCPE实例相同节点的区域和运营商，相同节点内业务系统和SAG vCPE实例可内网互通。本示例为**华东**大区，1个**移动实例**。
5.  创建服务后，您可以查看ENS实例信息。

    1.  在左侧导航栏，单击**资源管理**。

    2.  单击**实例**页签。

    3.  在实例页面，单击**全部服务**，选择刚刚创建的ENS服务ID，查看当前服务下已创建的实例公网IP地址等信息。

        ![查看ENS镜像](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7713129951/p139258.png)

6.  ENS创建完成后，您需要部署您的业务系统并将SAG vCPE设备的序列号和密钥绑定到ENS SAG vCPE实例中：

    1.  部署业务系统。

        请您根据您的业务需要进行部署，此处不再详细描述。

    2.  配置ENS SAG vCPE实例。

        SAG vCPE镜像安装完成后，您需要将购买的SAG vCPE设备的序列号和密钥绑定到ENS SAG vCPE实例中。绑定操作由阿里云网络团队帮您完成，您需要[提交工单](https://workorder.console.aliyun.com/console.htm?spm=a2c8b.12571063.0.0.6c3a1f74GNUcri#/ticket/add?productCode=smartag&commonQuestionId=3317&isSmart=true)，并提供以下信息：

        -   ENS SAG vCPE实例的公网IP地址。
        -   ENS SAG vCPE实例的登录密码。
        -   SAG vCPE设备的序列号和密钥。

## 步骤三：SAG vCPE设备网络配置

ENS部署完成后，您还需要在智能接入网关管理控制台对SAG vCPE设备进行网络配置，以便SAG vCPE设备与云上资源互通。

1.  配置线下路由同步方式。

    1.  登录[智能接入网关管理控制台](https://smartag.console.aliyun.com)。

    2.  在顶部菜单栏，选择目标区域。

    3.  在**智能接入网关**页面，找到目标实例，单击**操作**列的**网络配置**。

    4.  在**线下路由同步方式**页面，单击**添加静态路由**。

    5.  输入您业务系统实例所在的私网网段，单击**确定**。

        ![线下路由同步](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1086359951/p139262.png)

2.  绑定云连接网。

    云连接网是智能接入网关的重要组成部分，智能接入网关通过云连接网将您的网络接入阿里云。更多信息，请参见[云连接网介绍](/cn.zh-CN/配置指南/云连接网/云连接网介绍.md)。

    如果您未创建过云连接网，请先创建云连接网实例，再进行下面的绑定操作。具体操作，请参见[创建云连接网](/cn.zh-CN/配置指南/云连接网/创建云连接网.md)。

    1.  在**智能接入网关**页面，找到目标实例，单击**操作**列的**网络配置**。

    2.  单击**绑定网络详情**页签。

    3.  单击**添加网络**，选择目标云连接网实例，然后单击**确定**。

    4.  在您绑定网络后，在**设备管理**页面下，SAG vCPE设备的VPN状态和管控状态均变为正常。

        ![查看SAG vCPE状态](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1086359951/p139110.png)

3.  配置云企业网。

    云企业网可让SAG vCPE设备和云上VPC资源互通。关于云企业网更多信息，请参见[什么是云企业网]()。

    您需要参考以下操作将SAG vCPE设备绑定云企业网，并在云企业网中加载已创建的VPC实例，操作完成后，SAG vCPE和VPC实例可学习到对方的路由。

    1.  在左侧导航栏，单击**云连接网**。

    2.  在**云连接网**页面，找到目标云连接网实例，单击**操作**列的**绑定云企业网**。

    3.  在绑定云企业网页面，选择要绑定的云企业网实例，然后单击**确定**。

        您可以通过以下两种方式选择目标云企业网实例，本示例选择**新建CEN**。

        -   **选择现有CEN**：如果您已经创建了云企业网，您可以单击下方文本框，选择已创建的云企业网实例进行绑定。
        -   **新建CEN**：如果您未创建过云企业网，您可以在下方文本框中，输入云企业网实例名称，系统会为您新建云企业网实例并自动进行绑定。

            云企业网实例名称长度为2~100个字符，以大小写字母或中文开头，可包含数字、下划线（\_）或短划线（-）。

    4.  将您已经创建的VPC实例，绑定到此云企业网中。具体操作，请参见[加载网络实例]()。

    5.  将VPC加载到云企业网后，您需要为VPC下的云服务器（ECS）配置安全组，允许ENS中的业务私网网段访问VPC资源。具体操作，请参见[添加安全组规则](/cn.zh-CN/安全/安全组/添加安全组规则.md)。

        ![安全组设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1086359951/p139292.png)


## 步骤四：业务系统路由配置

为实现业务系统和云上资源互通，您需要为业务系统配置访问云上资源的路由。

1.  登录ENS中业务系统实例。

    1.  以管理员身份打开您电脑的cmd程序。

    2.  通过`ssh`方式登录您的业务系统实例。

    ```
    ssh root@120.XX.XX.133   #通过业务系统实例公网IP地址进行登录，请您根据实际情况进行公网IP地址更换。
    
    密码                     #您业务系统实例的登录密码。     
    ```

2.  配置路由。

    将要访问的云上网段的下一跳指向SAG vCPE实例的私网网卡IP地址，由SAG vCPE帮您完成和云上资源的互通。

    ```
    #在/etc/sysconfig/static-routes文档中写入永久静态路由。
    
    a. vi /etc/sysconfig/static-routes #创建并进入static-routes文档。
    b. #按下键盘的i键，进入文档编辑模式。
    c. any net 192.168.0.0/24 gw 10.0.2.3 #配置路由。将要访问的云上网段的下一跳指向SAG vCPE实例的私网网卡IP地址。
    d. :wq   #输入:wq并回车，保存退出文档。
    e. service network restart #重启网络服务。
    f. route -n #查看添加的路由。
    ```

3.  路由配置完成后，通过`ping`命令，测试和云上资源的连通性。

    ![连通性](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8713129951/p139264.png)


