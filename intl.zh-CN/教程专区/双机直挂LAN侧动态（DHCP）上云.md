# 双机直挂LAN侧动态（DHCP）上云

本教程将指导您使用智能接入网关（SAG）双机直挂组网的方式、LAN侧使用DHCP协议将本地网络接入阿里云，提高您网络的可用性。

-   您已经创建了专有网络（VPC），详情请参见[创建专有网络](/intl.zh-CN/专有网络和交换机/管理专有网络/创建专有网络.md)。
-   您已经创建云企业网并绑定了VPC网络实例，详情请参见[创建云企业网实例]()。

本教程以某企业本地机构上云为例进行说明。该企业已经在北京地域创建了VPC并在其中部署了应用服务，现在该企业希望通过智能接入网关将位于中国内地区域的本地机构接入阿里云，实现和云上资源的互通。该企业计划采用两台SAG-1000型号的设备，通过双机直挂组网方式将本地机构接入阿里云。其中，两台智能接入网关设备LAN侧启用DHCP协议，集中管理和动态下发客户端IP地址，帮企业减少IP地址运维工作；同时两台设备均开启DHCP Failover和HA功能，主备设备之间互为DHCP服务器和网关的备份，提高本地机构网络的可用性。

![双机直挂HA上云](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4112659951/p101679.png)

## 网段规划

以下为本教程IP地址及网段规划示例值，如您需要自行规划IP地址及网段，请确保各个IP地址及网段不冲突。

|项目|网段及IP地址规划|
|--|---------|
|北京VPC|私网网段：10.0.0.0/16|
|出口路由器|端口G1：192.168.100.2/30|
|端口G2：192.168.200.2/30|
|智能接入网关（主）|-   WAN端口5：采用静态IP连接类型
    -   端口IP地址：192.168.100.1/30
    -   网关：192.168.100.2
-   LAN端口4：采用动态IP连接类型
    -   端口IP地址：192.168.50.1/24
    -   DHCP地址段：192.168.50.3~192.168.50.253
    -   开启DHCP Failover功能
    -   启用HA：虚IP地址为192.168.50.254 |
|智能接入网关（备）|-   WAN端口5：采用静态IP连接类型
    -   端口IP地址：192.168.200.1/30
    -   网关：192.168.200.2
-   LAN端口4：采用动态IP连接类型
    -   端口IP地址：192.168.50.2/24
    -   DHCP地址段：192.168.50.3~192.168.50.253
    -   开启DHCP Failover功能
    -   启用HA：虚IP地址为192.168.50.254 |
|二层交换机|-   G11端口连接智能接入网关（主）的LAN端口4
-   G12端口连接智能接入网关（备）的LAN端口4 |
|本地机构|私网网段：192.168.50.0/24|

## 配置流程

![配置流程](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4112659951/p162736.png)

## 步骤一：购买智能接入网关设备

在智能接入网关控制台购买智能接入网关设备后，阿里云会将智能接入网关设备寄送给您，并创建一个智能接入网关实例方便您管理设备。

**说明：** 如果您要使用智能接入网关的区域非中国内地时，您需要通过第三方公司购买硬件，详情请参见[购买SAG硬件](/intl.zh-CN/购买指南/购买SAG硬件.md)。

1.  登录[智能接入网关管理控制台](https://smartag.console.aliyun.com)。

2.  在智能接入网关页面，单击**购买智能接入网关**。

3.  选择**创建智能接入网关（硬件版）**。

4.  根据以下信息配置智能接入网关设备信息，然后单击**立即购买**。

    -   **区域**：智能接入网关设备使用区域。本示例选择**中国内地**。
    -   **实例类型**：选择智能接入网关设备规格。本示例选择**SAG-1000**。
    -   **已有SAG硬件**：选择是否已有智能接入网关硬件设备。本示例选择**否**。
    -   **版本**：智能接入网关设备版本。本示例使用默认**标准版**。
    -   **购买数量**：智能接入网关设备购买数量。本示例选择**2**。
    -   **区域**：智能接入网关设备使用的带宽区域。该区域类型和智能接入网关设备使用区域保持一致，且无法修改。
    -   **实例名称**：智能接入网关实例名称。

        名称长度为2~128个字符，以大小写字母或中文开头，可包含数字、英文句点（.）、连接号（-）和下划线（\_）。

    -   **带宽峰值**：选择通信网络的带宽峰值。本示例选择**50 Mbps**。
    -   **购买时长**：选择购买时长。
5.  确认订单信息，然后单击**确认购买**。

6.  在弹出的收货地址对话框，填写网关设备的收货地址，然后单击**立即购买**。

7.  在弹出的支付页面，选择支付方式，然后完成支付。


您可以在智能接入网关实例页面查看是否下单成功。系统会在下单后两个工作日内发货。如果超期，您可以[提交工单](https://workorder-intl.console.aliyun.com/?spm=5176.15120809.nav-right.dticket.130266ebEB92in#/ticket/add/?productId=1308)查看物流状态。

![查看下单状态](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4112659951/p101651.png)

## 步骤二：激活连接智能接入网关设备

收到智能接入网关设备后，请检查设备配件是否完整，详情请参见[SAG-1000设备说明](/intl.zh-CN/硬件手册/SAG-1000使用说明/SAG-1000设备说明.md)。

1.  登录[智能接入网关管理控制台](https://smartag.console.aliyun.com/)。

2.  在顶部菜单栏，选择目标区域。

3.  在智能接入网关页面，找到目标实例。

4.  单击目标实例**操作**列下的**激活**。

5.  在激活对话框，单击**确定**。

6.  单击目标实例ID链接，进入智能接入网关设备详情页面，查看智能接入网关设备的主备关系。

    **说明：**

    -   智能接入网关设备默认采用SN号判断主备关系，SN号小的为主设备。设备主备关系请以控制台为准。
    -   如果您通过第三方公司购买的设备，需手动将设备与智能接入网关实例进行绑定，详情请参见[添加设备](/intl.zh-CN/配置指南/设备配置/设备绑定/添加设备.md)。绑定设备时您可自行决定设备的主备关系，先绑定的设备默认为主设备。
7.  激活设备后，您还需要根据设备主备关系将智能接入网关设备按照拓扑所示接入到本地机构中。

    智能接入网关（主）：

    -   通过网线，将智能接入网关的WAN（端口5）连接到出口路由器的G1端口上。
    -   通过网线，将智能接入网关的LAN（端口4）连接到二层交换机的G11端口上。
    智能接入网关（备）：

    -   通过网线，将智能接入网关的WAN（端口5）连接到出口路由器的G2端口上。
    -   通过网线，将智能接入网关的LAN（端口4）连接到二层交换机的G12端口上。

## 步骤三：配置智能接入网关设备

您需要登录智能接入网关的Web管理页面进行设备配置。在执行此操作前，请保持设备启动且4G信号正常，已经连接到阿里云。

1.  本地客户端通过网线连接智能接入网关（主）设备管理口（默认为2号端口）登录Web管理页面。详情请参见[步骤一：本地客户端配置](/intl.zh-CN/硬件手册/SAG-1000使用说明/SAG-1000 Web配置.md)和[步骤二：首次登录设置密码](/intl.zh-CN/硬件手册/SAG-1000使用说明/SAG-1000 Web配置.md)。

2.  分配端口角色。

    **说明：** 智能接入网关设备出厂时，系统默认分配端口5为WAN口，端口4为LAN口。如果您的系统为默认配置您可以跳过该步骤；如果您的系统配置做过端口角色修改，请参照以下步骤分配端口角色，确保设备端口角色符合配置需求。

    1.  在Web配置页面，单击**设置**。

    2.  在左侧导航栏，单击**端口分配**。

    3.  在端口分配页面，找到目标端口并选择端口类型。

        ![分配端口角色](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4112659951/p162661.png)

        -   **端口5**：选择**WAN**。
        -   **端口4**：选择**LAN**。
    4.  单击**确定**。

3.  配置WAN口。

    1.  在左侧导航栏，单击**WAN口管理**。

    2.  在WAN口管理页面，单击**端口5（WAN）**开始配置WAN口信息。

        ![Web-配置主WAN口](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/4112659951/p162314.png)

        -   **连接类型**：选择**静态IP**。
        -   **IP地址**：WAN口IP地址。本示例输入192.168.100.1。
        -   **掩码**：WAN口IP地址掩码。本示例输入255.255.255.252。
        -   **网关**：网关IP地址。本示例输入192.168.100.2。

            **说明：** 配置网关后，智能接入网关设备会添加一条默认路由。

    3.  单击**确定**。

4.  配置LAN口。

    1.  在左侧导航栏，单击**LAN口管理**。

    2.  在LAN口管理页面，单击**端口4（LAN）**开始配置LAN口信息。

        ![Web-配置主LAN](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/3697310061/p162320.png)

        -   **连接类型**：选择**动态IP**。
        -   **私网网段**：选择**自定义网段**，并输入192.168.50.0/24。
        -   **接口IP**：LAN口IP地址。本示例输入192.168.50.1。
        -   **DHCP起始IP**：本示例输入192.168.50.3。
        -   **DHCP结束IP**：本示例输入192.168.50.253。
        -   **地址租期**：48小时。
        -   **DHCP Failover**：开启。

            **说明：** DHCP Failover功能需联合HA功能使用，其中HA虚IP地址将作为网关地址，被自动下发至客户端。智能接入网关主设备和备设备同时开启DHCP Failover和HA功能后，主备设备之间互为DHCP服务器和网关的备份，帮您提高网络的可用性。

    3.  单击**确定**。

5.  启用HA功能。

    1.  在左侧导航栏，单击**HA配置**。

    2.  在HA配置页面，选择**静态路由HA**，并开始配置HA信息。

        ![Web配置主HA](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/9436310061/p162323.png)

        -   **端口**：选择**端口4（LAN）**。
        -   **虚IP**：虚拟IP地址。本示例输入192.168.50.254。
    3.  单击**确定**。

6.  配置智能接入网关（备）设备。

    请参见智能接入网关（主）设备的登录配置方式，对智能接入网关（备）设备进行配置，配置信息请参见下文：

    -   端口5（WAN）配置：
        -   **连接类型**：选择**静态IP**。
        -   **IP地址**：WAN口IP地址。本示例输入192.168.200.1。
        -   **掩码**：WAN口IP地址掩码。本示例输入255.255.255.252。
        -   **网关**：网关IP地址。本示例输入192.168.200.2。

            **说明：** 配置网关后，智能接入网关设备会添加一条默认路由。

    -   端口4（LAN）配置：
        -   **连接类型**：选择**动态IP**。
        -   **私网网段**：选择**自定义网段**，并输入192.168.50.0/24。
        -   **接口IP**：LAN口IP地址。本示例输入192.168.50.2。
        -   **DHCP起始IP**：本示例输入192.168.50.3。
        -   **DHCP结束IP**：本示例输入192.168.50.253。
        -   **地址租期**：48小时。
        -   **DHCP Failover**：开启。
    -   HA配置：选择**静态路由HA**。
        -   **端口**：选择**端口4（LAN）**。
        -   **虚IP**：虚拟IP地址。本示例输入192.168.50.254。

## 步骤四：配置线下路由同步方式

您需要在智能接入网关管理控制台配置线下路由同步方式，将本地机构的路由同步到云上，为后续和云上资源互通做准备。

1.  登录[智能接入网关管理控制台](https://smartag.console.aliyun.com/)。

2.  在顶部菜单栏，选择目标区域。

3.  在智能接入网关页面，单击目标实例ID连接。

4.  在智能接入网关实例详情页面，单击**网络配置**页签。

5.  在页签左侧区域，单击**线下路由同步方式**。

6.  选择**静态路由**，然后单击**添加静态路由**，配置静态路由信息，最后单击**确定**。

    静态路由添加为本地机构要和云上互通的网段：192.168.50.0/24。

    ![线下路由同步方式](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/5112659951/p162311.png)


## 步骤五：配置云上网络连接

在配置好设备后，您需要智能接入网关管理控制台配置云上网络连接，将本地机构接入阿里云。

1.  创建云连接网。

    1.  登录[智能接入网关管理控制台](https://smartag.console.aliyun.com)

    2.  在顶部菜单栏，选择**中国内地**区域。

        云连接网区域需和智能接入网关设备使用区域保持一致。

    3.  在左侧导航栏，单击**云连接网**。

    4.  在云连接网页面，单击**创建云连接网**。

    5.  在创建云连接网页面，配置云连接网名称，然后单击**确定**。

        云连接网名称长度为2~100个字符，以大小写字母或中文开头，可包含数字、下划线（\_）和连接号（-）。

        ![创建云连接网](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/5112659951/p76961.png)

2.  绑定云连接网。

    1.  在左侧导航栏，单击**智能接入网关**。

    2.  在智能接入网关页面，单击目标实例**操作**列的**网络配置**。

    3.  在页签左侧区域，单击**绑定网络详情**。

    4.  在绑定网络详情页签下，单击**添加网络**，选择绑定云连接网并选择刚刚创建的云连接网实例，然后单击**确定**。

        ![添加网络](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/5112659951/p132840.png)

3.  绑定云企业网。

    绑定后，云连接网中的智能接入网关设备便可以和云企业网实例中已加载的网络实例VPC通信。

    1.  在左侧导航栏，单击**云连接网**。

    2.  单击刚刚创建的云连接网实例**操作**列的**绑定云企业网**。

    3.  在绑定云企业网页面，**选择现有CEN**并选择要绑定的云企业网实例，单击**确定**。

        ![云企业网](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/5112659951/p63012.png)

4.  配置安全组规则。

    您需要为VPC中的云服务器（ECS）实例配置安全组规则，允许本地机构的私网网段192.168.50.0/24访问ECS中的资源。详情请参见[添加安全组规则](/intl.zh-CN/安全/安全组/添加安全组规则.md)。


## 步骤六：访问测试

完成上述配置后，您可以设置您的客户端以获取IP地址，然后尝试访问已连接的VPC中部署的云资源。

1.  请将您客户端网卡设置为自动获得IP地址方式，操作详情请参见您客户端操作系统手册。下图为Windows操作系统设置示例。

    ![自动获取IP](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/5112659951/p162415.png)

2.  完成设置后，智能接入关会自动向客户端下发IP地址。客户端获取IP地址后，您可以尝试访问已连接的VPC中部署的云资源。


